#!/bin/bash
# tofu-safe - OpenTofu åŒ…è£è…³æœ¬ï¼Œæä¾›åŸºæ–¼ç’°å¢ƒçš„åˆªé™¤ä¿è­·

set -e

# é¡è‰²è¼¸å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# è®€å–ç’°å¢ƒè®Šæ•¸
ENVIRONMENT=${TF_VAR_environment:-production}

# å¾ terraform.tfvars è®€å–ï¼ˆå¦‚æœç’°å¢ƒè®Šæ•¸æœªè¨­å®šï¼‰
if [[ -z "${TF_VAR_environment}" ]] && [[ -f "terraform.tfvars" ]]; then
    TFVARS_ENV=$(grep '^environment' terraform.tfvars | sed 's/environment[[:space:]]*=[[:space:]]*"\(.*\)"/\1/' | tr -d ' ')
    if [[ -n "$TFVARS_ENV" ]]; then
        ENVIRONMENT="$TFVARS_ENV"
    fi
fi

echo -e "${YELLOW}ğŸ“‹ ç•¶å‰ç’°å¢ƒ: ${ENVIRONMENT}${NC}"

# æª¢æŸ¥æ˜¯å¦æ˜¯åˆªé™¤æ“ä½œ
if [[ "$1" == "destroy" ]]; then
    if [[ "$ENVIRONMENT" == "production" ]]; then
        echo -e "${RED}âŒ éŒ¯èª¤ï¼šä¸å…è¨±åˆªé™¤ç”Ÿç”¢ç’°å¢ƒï¼${NC}"
        echo ""
        echo "å¦‚æœç¢ºå¯¦éœ€è¦åˆªé™¤ç”Ÿç”¢ç’°å¢ƒï¼Œè«‹ä½¿ç”¨ä»¥ä¸‹ä»»ä¸€æ–¹æ³•ï¼š"
        echo ""
        echo "æ–¹æ³• 1: è‡¨æ™‚è¨­å®šç’°å¢ƒè®Šæ•¸"
        echo "  export TF_VAR_environment=\"staging\""
        echo "  ./tofu-safe destroy"
        echo ""
        echo "æ–¹æ³• 2: ä¿®æ”¹ terraform.tfvars"
        echo "  # å°‡ environment = \"production\" æ”¹ç‚º \"staging\""
        echo "  ./tofu-safe destroy"
        echo ""
        echo "æ–¹æ³• 3: ç›´æ¥ä½¿ç”¨ tofuï¼ˆç¹éä¿è­·ï¼Œä¸æ¨è–¦ï¼‰"
        echo "  tofu destroy"
        echo ""
        exit 1
    else
        echo -e "${YELLOW}âš ï¸  è­¦å‘Šï¼šå³å°‡åˆªé™¤ ${ENVIRONMENT} ç’°å¢ƒçš„æ‰€æœ‰è³‡æº${NC}"
        echo ""
    fi
fi

# åŸ·è¡Œ tofu å‘½ä»¤
echo -e "${GREEN}â–¶ï¸  åŸ·è¡Œ: tofu $@${NC}"
tofu "$@"
