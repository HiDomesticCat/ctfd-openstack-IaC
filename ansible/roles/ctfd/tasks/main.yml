# roles/ctfd/tasks/main.yml

# ── 基礎套件 ──────────────────────────────────────────────
- name: 確保基礎套件已安裝
  apt:
    name:
      - git
      - curl
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
      - software-properties-common
    state: present
    update_cache: yes

# ── Docker 官方倉庫 ────────────────────────────────────────
- name: 建立 apt keyrings 目錄
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: 下載 Docker 官方 GPG 金鑰
  get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: "0644"
    force: false

- name: 取得系統架構
  command: dpkg --print-architecture
  register: dpkg_arch
  changed_when: false

- name: 加入 Docker 官方 apt 倉庫
  apt_repository:
    repo: >-
      deb [arch={{ dpkg_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc]
      https://download.docker.com/linux/ubuntu
      {{ ansible_distribution_release }} stable
    state: present
    filename: docker
    update_cache: yes

- name: 安裝 docker-buildx-plugin
  apt:
    name: docker-buildx-plugin
    state: present

# ── Docker 服務 ───────────────────────────────────────────
- name: 確保 Docker 服務已啟動並設為開機啟動
  systemd:
    name: docker
    state: started
    enabled: yes

- name: 確保 ubuntu 使用者在 docker 群組
  user:
    name: ubuntu
    groups: docker
    append: yes

# ── 建立目錄 ───────────────────────────────────────────────
- name: 建立 CTFd 部署目錄
  file:
    path: "{{ ctfd_deploy_dir }}"
    state: directory
    mode: "0755"
    owner: ubuntu
    group: ubuntu

# ── 版本感知：判斷是否需要重建 ────────────────────────────
- name: 讀取上次部署的 CTFd 版本
  slurp:
    src: "{{ ctfd_deploy_dir }}/.deployed_version"
  register: last_ctfd_version
  ignore_errors: yes

- name: 判斷是否需要重建（版本變更或首次部署）
  set_fact:
    ctfd_needs_rebuild: >-
      {{
        last_ctfd_version.failed | default(true) or
        (last_ctfd_version.content | b64decode | trim) != (ctfd_version ~ '+' ~ ctfd_chall_manager_version)
      }}

# ── 清理舊環境（版本變更時）──────────────────────────────
- name: 停止並清除舊容器與 volumes（版本變更時）
  shell: |
    cd {{ ctfd_deploy_dir }}
    docker compose down -v 2>/dev/null || true
    docker rmi ctfd-ctfd --force 2>/dev/null || true
    docker builder prune -af 2>/dev/null || true
    rm -rf {{ ctfd_deploy_dir }}/.data/mysql
  when: ctfd_needs_rebuild

# ── 拉取程式碼（在 build 之前）───────────────────────────
- name: Git Clone CTFd 原始碼
  git:
    repo: "{{ ctfd_repo_url }}"
    dest: "{{ ctfd_deploy_dir }}"
    version: "{{ ctfd_version }}"
    force: yes

# ── 安裝外掛（在 build 之前）─────────────────────────────
- name: 確保 CTFd plugins 目錄存在
  file:
    path: "{{ ctfd_deploy_dir }}/CTFd/plugins"
    state: directory
    mode: "0755"

- name: 安裝 ctfd-chall-manager 外掛
  git:
    repo: "https://github.com/ctfer-io/ctfd-chall-manager.git"
    dest: "{{ ctfd_deploy_dir }}/CTFd/plugins/ctfd_chall_manager"
    version: "{{ ctfd_chall_manager_version }}"
    force: yes

- name: 確保不存在幽靈資料夾（ctfd-chall-manager，連字號版本）
  file:
    path: "{{ ctfd_deploy_dir }}/CTFd/plugins/ctfd-chall-manager"
    state: absent

# ── 啟動 CTFd ─────────────────────────────────────────────
- name: 啟動 CTFd（含重 build，版本變更時）
  shell: |
    cd {{ ctfd_deploy_dir }}
    docker compose up -d --build
  when: ctfd_needs_rebuild

- name: 啟動 CTFd（無版本變更，直接啟動）
  shell: |
    cd {{ ctfd_deploy_dir }}
    docker compose up -d
  when: not ctfd_needs_rebuild

# ── 等待 CTFd 健康 ────────────────────────────────────────
- name: 等待 CTFd HTTP 回應（最多 180 秒）
  uri:
    url: "http://127.0.0.1:8000"
    status_code: [200, 302]
  register: ctfd_health
  until: ctfd_health.status in [200, 302]
  retries: 36
  delay: 5

# ── 寫入版本記錄 ──────────────────────────────────────────
- name: 寫入本次部署版本（ctfd + 外掛版本組合）
  copy:
    content: "{{ ctfd_version }}+{{ ctfd_chall_manager_version }}"
    dest: "{{ ctfd_deploy_dir }}/.deployed_version"