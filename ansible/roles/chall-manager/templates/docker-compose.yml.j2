# chall-manager docker-compose（由 Ansible 渲染）
# 參考文件：https://github.com/ctfer-io/chall-manager

services:
  # ── 本機 OCI Registry ──────────────────────────────────────
  # 存放 scenario OCI artifact（zip），不需要 Docker Hub 帳號
  registry:
    image: registry:2
    restart: unless-stopped
    ports:
      - "{{ registry_port }}:5000"
    volumes:
      - registry-data:/var/lib/registry

  # ── chall-manager 後端微服務 ───────────────────────────────
  chall-manager:
    image: ctferio/chall-manager:{{ chall_manager_version }}
    restart: unless-stopped
    command:
      - /chall-manager
      - --oci.insecure
    ports:
      - "127.0.0.1:{{ chall_manager_port }}:8080"
    expose:
      - "8080"
    # ✅ 做法一：OCI cache 寫入 tmpfs（RAM），容器每次重啟自動全清
    # 根治 "remove Pulumi.hash.yaml: no such file" stale cache bug
    # 額外好處：讀寫速度快（RAM > disk I/O）
    tmpfs:
      - /root/.cache/chall-manager:size=512m,mode=1777
    environment:
      # 分散式鎖後端
      CM_LOCK: etcd
      CM_LOCK_ETCD_ENDPOINTS: "etcd:2379"

      # Scenarios 目錄（對應到 volumes 掛載）
      CM_DIRECTORY: /scenarios

      # OpenStack 憑證（由 Pulumi scenario 程式繼承使用）
      OS_AUTH_URL: "{{ openstack_auth_url }}"
      OS_PROJECT_NAME: "{{ openstack_project_name }}"
      OS_USERNAME: "{{ openstack_username }}"
      OS_PASSWORD: "{{ openstack_password }}"
      OS_REGION_NAME: "{{ openstack_region }}"
      OS_USER_DOMAIN_NAME: "{{ openstack_user_domain }}"
      OS_PROJECT_DOMAIN_NAME: "{{ openstack_project_domain }}"
      OS_IDENTITY_API_VERSION: "3"

      # ── 題目設定（Pulumi __main__.py 從環境變數讀取）─────────
      # chall-manager 容器啟動的 Pulumi 子程序會繼承以下 env vars
      CHALLENGE_IMAGE_ID: "{{ challenge_image_id }}"
      CHALLENGE_NETWORK_ID: "{{ challenge_network_id }}"
      CHALLENGE_FLAVOR: "{{ challenge_flavor | default('general.small') }}"
      CHALLENGE_PORT: "{{ challenge_port | default('8080') }}"
      CHALLENGE_FIP_POOL: "{{ challenge_fip_pool | default('public') }}"
      CHALLENGE_BASE_FLAG: "{{ challenge_base_flag | default('replace_me') }}"
      CHALLENGE_FLAG_PREFIX: "{{ challenge_flag_prefix | default('CTF') }}"

      # Pulumi local backend（不需要 Pulumi Cloud 帳號）
      PULUMI_BACKEND_URL: "file:///pulumi-state"
      PULUMI_CONFIG_PASSPHRASE: ""

    volumes:
      # ✅ 不加 :ro：chall-manager 執行 Pulumi 時可能需要寫入暫存檔
      # Pulumi state 已獨立掛載到 pulumi-state volume
      - {{ chall_manager_scenarios_dir }}:/scenarios
      - pulumi-state:/pulumi-state
    depends_on:
      etcd:
        condition: service_healthy
      registry:
        condition: service_started
    networks:
      - default
      - ctfd_internal

  # ── 分散式鎖：etcd ─────────────────────────────────────────
  etcd:
    image: {{ etcd_image }}
    restart: unless-stopped
    # ✅ 明確指定 command，避免不同版本環境變數讀取行為不一致
    command:
      - etcd
      - --data-dir=/var/lib/etcd
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd:2379
    healthcheck:
      test: ["CMD", "etcdctl", "--endpoints=http://localhost:2379", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 3
    volumes:
      # ✅ 修正：官方 etcd image 預設資料目錄是 /var/lib/etcd，不是 /var/etcd
      - etcd-data:/var/lib/etcd

volumes:
  registry-data:
  pulumi-state:
  etcd-data:

networks:
  default:
  ctfd_internal:
    external: true