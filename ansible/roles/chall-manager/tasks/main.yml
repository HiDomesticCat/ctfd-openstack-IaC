# roles/chall-manager/tasks/main.yml

# ── 允許使用 insecure local registry ─────────────────────────
# Docker 預設不允許 HTTP registry，需要設定白名單
- name: 確保 /etc/docker 目錄存在
  file:
    path: /etc/docker
    state: directory
    mode: "0755"

- name: 設定 Docker 允許 insecure local registry
  copy:
    dest: /etc/docker/daemon.json
    content: |
      {
        "insecure-registries": ["{{ registry_host }}:{{ registry_port }}"]
      }
    mode: "0644"
  register: docker_daemon_updated

- name: 重啟 Docker（若 daemon.json 有變更）
  systemd:
    name: docker
    state: restarted
  when: docker_daemon_updated.changed

# ── 建立目錄 ──────────────────────────────────────────────
- name: 建立 chall-manager 根目錄
  file:
    path: "{{ chall_manager_dir }}"
    state: directory
    mode: "0755"
    owner: ubuntu
    group: ubuntu

- name: 建立 scenarios 目錄
  file:
    path: "{{ chall_manager_scenarios_dir }}"
    state: directory
    mode: "0755"
    owner: ubuntu
    group: ubuntu

# ── 同步 scenarios 原始碼到遠端 ───────────────────────────────
- name: 同步 scenarios/ 到遠端（rsync）
  synchronize:
    src: "{{ playbook_dir }}/scenarios/"
    dest: "{{ chall_manager_scenarios_dir }}/"
    delete: yes
    recursive: yes
    rsync_opts:
      - "--exclude='.git'"
      - "--exclude='venv/'"
      - "--exclude='__pycache__/'"
      - "--exclude='*.pyc'"
      - "--chown=ubuntu:ubuntu"

# ── 部署 Docker Compose（registry + chall-manager + etcd）─────
- name: 渲染 chall-manager docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: "{{ chall_manager_dir }}/docker-compose.yml"
    mode: "0644"
    owner: ubuntu
    group: ubuntu
  register: compose_updated

- name: 啟動 chall-manager 服務（含 registry 和 etcd）
  community.docker.docker_compose_v2:
    project_src: "{{ chall_manager_dir }}"
    state: present

- name: 重啟 chall-manager（若 compose 有變更）
  community.docker.docker_compose_v2:
    project_src: "{{ chall_manager_dir }}"
    state: present
    recreate: always
  when: compose_updated.changed

# ── 等待 registry 就緒 ─────────────────────────────────────
- name: 等待 local registry 就緒
  uri:
    url: "http://{{ registry_host }}:{{ registry_port }}/v2/"
    status_code: 200
  register: registry_ready
  until: registry_ready.status == 200
  retries: 12
  delay: 5

# ── Build + Push scenario OCI images ─────────────────────────
# 逐一處理 scenarios/ 下有 Dockerfile 的目錄
- name: 找出所有含 Dockerfile 的 scenario 目錄
  find:
    paths: "{{ chall_manager_scenarios_dir }}"
    patterns: "Dockerfile"
    recurse: yes
  register: scenario_dockerfiles

- name: Build + Push 各 scenario OCI image
  shell: |
    scenario_dir="{{ item.path | dirname }}"
    scenario_name="{{ item.path | dirname | basename }}"
    image_tag="{{ registry_url }}/${scenario_name}:latest"

    echo "==> Building ${image_tag} ..."
    docker build -t "${image_tag}" "${scenario_dir}"

    echo "==> Pushing ${image_tag} ..."
    docker push "${image_tag}"

    echo "done:${image_tag}"
  args:
    executable: /bin/bash
  loop: "{{ scenario_dockerfiles.files }}"
  register: build_results
  # async+loop 中 item.stdout 不可用，移除 changed_when，shell 預設 rc==0 即 changed
  async: 600   # 最多等 600 秒
  poll: 15     # 每 15 秒輸出一次進度，避免看起來「卡住」

- name: 顯示 build 結果
  debug:
    msg: "{{ item.stdout_lines | default([]) | select('match', '^(==>|done:)') | list }}"
  loop: "{{ build_results.results }}"

# ── 確認 chall-manager Port 就緒 ──────────────────────────────
# chall-manager 是 gRPC 服務，沒有 REST /health endpoint
# 改用 TCP port 檢查確認服務已啟動
- name: 等待 chall-manager port 就緒（最多 60 秒）
  wait_for:
    host: 127.0.0.1
    port: "{{ chall_manager_port }}"
    timeout: 60
    state: started

- name: 顯示完成資訊
  debug:
    msg:
      - "chall-manager API: http://127.0.0.1:{{ chall_manager_port }}"
      - "Local registry: http://{{ registry_url }}"
      - "CTFd 外掛設定 → API URL: http://127.0.0.1:{{ chall_manager_port }}"
      - "Scenario image 範例: {{ registry_url }}/openstack-vm:latest"
